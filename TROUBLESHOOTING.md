# راهنمای رفع مشکلات اتصال

این راهنما برای حل مشکل "خطا در اتصال به سرور" در پروژه Mobile Book Verse Reader طراحی شده است.

## مشکلات شناسایی شده و راه‌حل‌ها

### ۱. مشکلات شبکه
**علائم:**
- پیام "خطا در اتصال به سرور"
- "خطا در اتصال به شبکه"

**راه‌حل‌ها:**
- بررسی اتصال اینترنت
- استفاده از DNS‌های عمومی (8.8.8.8, 1.1.1.1)
- غیرفعال کردن VPN یا پروکسی
- بررسی فایروال و آنتی‌ویروس

### ۲. مشکلات Supabase
**علائم:**
- "Error fetching interactive stories"
- "Supabase connection unhealthy"

**راه‌حل‌ها:**
- بررسی وضعیت سرویس Supabase در [status.supabase.com](https://status.supabase.com)
- اعتبارسنجی کلیدهای API
- بررسی محدودیت‌های نرخ درخواست

### ۳. مشکلات CORS
**علائم:**
- "CORS policy" در کنسول مرورگر
- درخواست‌های شکست خورده

**راه‌حل‌ها:**
- اجرای پروژه از طریق localhost (نه file://)
- بررسی تنظیمات CORS در Supabase Dashboard

### ۴. مشکلات مرورگر
**علائم:**
- خطاهای JavaScript در کنسول
- عدم پشتیبانی از ویژگی‌های جدید

**راه‌حل‌ها:**
- به‌روزرسانی مرورگر
- پاک کردن کش و کوکی‌ها
- استفاده از حالت incognito برای تست

## ابزارهای تشخیص

### ۱. صفحه تشخیص
برای دسترسی به ابزار تشخیص مشکلات:
```
http://localhost:8081/diagnostics
```

### ۲. نمایشگر وضعیت اتصال
نمایشگر وضعیت اتصال در بالای صفحه نمایش داده می‌شود و وضعیت شبکه و سرور را به‌صورت زنده نمایش می‌دهد.

## بهبودهای اعمال شده

### ۱. مدیریت خطای بهبود یافته
- پیام‌های خطای واضح‌تر
- تشخیص نوع خطا (شبکه، سرور، احراز هویت)
- بازیابی خودکار پس از برقراری اتصال

### ۲. مکانیزم تلاش مجدد
- تلاش مجدد خودکار برای خطاهای شبکه
- تأخیر تصاعدی برای جلوگیری از ازدحام
- عدم تلاش مجدد برای خطاهای احراز هویت

### ۳. مانیتورینگ اتصال
- بررسی وضعیت شبکه در زمان واقعی
- تست سلامت Supabase
- نمایش اطلاعات شبکه تفصیلی

### ۴. QueryClient بهینه‌سازی شده
- تنظیمات مناسب برای retry و cache
- مدیریت بهتر خطاها
- بازیابی خودکار پس از اتصال مجدد

## فایل‌های تغییر یافته

### هوک‌ها (Hooks)
- `src/hooks/useInteractiveStories.tsx` - بهبود مدیریت خطا
- `src/hooks/useBookLogs.tsx` - بهبود مدیریت خطا
- `src/hooks/useErrorRecovery.tsx` - مدیریت بازیابی خطا (جدید)

### کامپوننت‌ها (Components)
- `src/components/ConnectionStatus.tsx` - نمایشگر وضعیت اتصال (جدید)

### ابزارها (Utils)
- `src/utils/networkUtils.ts` - ابزارهای شبکه (جدید)

### صفحات (Pages)
- `src/pages/Diagnostics.tsx` - صفحه تشخیص مشکلات (جدید)

### کانفیگ
- `src/integrations/supabase/client.ts` - بهبود کلاینت Supabase
- `src/App.tsx` - اضافه کردن نمایشگر وضعیت و QueryClient بهبود یافته
- `vite.config.ts` - بهبود تنظیمات CORS

## نحوه استفاده

### ۱. راه‌اندازی محیط توسعه
```bash
npm run dev
```

### ۲. بررسی مشکلات
- مراجعه به `/diagnostics` برای تشخیص مشکلات
- بررسی نمایشگر وضعیت در بالای صفحه
- مشاهده کنسول مرورگر برای جزئیات بیشتر

### ۳. تست اتصال
- استفاده از ابزار تشخیص برای بررسی تمامی اتصالات
- مشاهده نتایج تست‌های مختلف
- دریافت راهنمایی‌های رفع مشکل

## مانیتورینگ

### ۱. لاگ‌ها
تمامی خطاها و اطلاعات اتصال در کنسول مرورگر ثبت می‌شوند:
- `Network error fetching stories` - خطای شبکه
- `Supabase health check failed` - مشکل Supabase
- `Interactive stories loaded` - بارگیری موفق

### ۲. Toast Messages
پیام‌های کاربرپسند برای انواع خطاها:
- خطای شبکه
- خطای سرور
- خطای احراز هویت
- بازیابی موفق

## پشتیبانی از حالت آفلاین

پروژه اکنون شامل مکانیزم‌هایی برای مدیریت حالت آفلاین است:
- تشخیص قطعی اتصال
- ذخیره‌سازی محلی داده‌ها
- بازیابی خودکار پس از برقراری اتصال

## نکات مهم

1. **همیشه از localhost استفاده کنید** - نه از file://
2. **مرورگر خود را به‌روز نگه دارید**
3. **در صورت مشکل، ابتدا صفحه تشخیص را بررسی کنید**
4. **کش مرورگر را در صورت مشکل پاک کنید**
5. **از ابزارهای توسعه‌دهنده مرورگر برای جزئیات بیشتر استفاده کنید**

## تماس برای پشتیبانی

در صورت ادامه مشکل:
- اسکرین‌شات از صفحه تشخیص بگیرید
- لاگ‌های کنسول را کپی کنید
- اطلاعات مرورگر و سیستم‌عامل را ارائه دهید
